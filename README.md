# Go-Server Template

A lightweight Go server template with OpenAPI, PostgreSQL, and database migrations using Chi router.

Tools which help designing an API (not sponsored or affiliated):
[api-fiddle](https://api.api-fiddle.com/v1/public/resources/oas_api_3_1/tommys-organization-wzn/yellow-sheep-yssp)
[apidog](https://apidog.com/)

## Table of Contents

- [Features](#features)
- [Directory Structure](#directory-structure)
- [Requirements](#requirements)
- [Configuration](#configuration)
- [Migrations](#migrations)
- [DB Schema](#db-schema)
- [API Spec](#api-spec)
- [Get Started](#get-started)

## Features

- **Chi Router** - Lightweight, fast HTTP router
- **OpenAPI Code Generation** - Generate server code from OpenAPI spec
- **PostgreSQL** - Database support with sqlc for type-safe queries
- **Database Migrations** - Version-controlled schema migrations
- **CORS Support** - Configurable CORS middleware
- **Security Headers** - Security headers middleware
- **Request Validation** - OpenAPI-based request validation
- **Colored Logging** - Colored request logs in debug mode
- **Route Listing** - Automatic route listing on startup (debug mode)
- **Environment Configuration** - Configuration via .env file

## Directory Structure

```
.
├── docs/
│   └── openapi.yaml          # OpenAPI specification
├── internal/
│   ├── api/                  # Generated OpenAPI server code
│   ├── config/               # Configuration management
│   ├── handler/              # HTTP request handlers
│   ├── middleware/           # HTTP middleware (logger, security headers)
│   ├── repository/           # Database queries (generated by sqlc)
│   ├── routes/               # Router setup
│   └── utils/                # Utility functions (route printer)
├── migrations/               # Database migration files
├── query/                    # SQL queries (input for sqlc)
├── main.go                   # Application entry point
├── Makefile                  # Build and development commands
├── sqlc.yaml                 # sqlc configuration
└── oapi-codegen.yaml         # oapi-codegen configuration
```

# Requirements

- sqlc: `brew install sqlc`
- golang-migrate: `brew install golang-migrate`

## Configuration

Configuration is managed via environment variables. Copy `.env.example` to `.env` and adjust values:

```bash
cp .env.example .env
```

The Makefile automatically reads `.env` values for migrations and database commands.

## Migrations

New: `make new NAME=xxx`

Up: `make up`

Down: `make down`

Database connection settings are read from `.env` (see Configuration section above). Migrations live in `migrations/`.

## DB Schema

Use sqlc to generate go boilerplate code: `sqlc generate`

## API Spec

OpenAPI is used to define the API spec. The spec is located in `docs/openapi.yaml`.
Generate the server boilerplate code using `oapi-codegen`:

```bash
make api-gen-code
```

which runs:

```bash
go run github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen --config=oapi-codegen.yaml docs/openapi.yaml
```

All handlers have to implemented by the `Server` struct in `internal/handler/handlers.go`.
To split the handlers into multiple files, create new files in the same package and add either directly implement the methods or create new structs that will be embedded by the `Server` and implement the methods there.

Example:

```go
type ClientHandler struct { }
func (s *ClientHandler) GetClient(_ context.Context, _ api.GetClientRequestObject) (api.GetClientResponseObject, error) {
	return api.GetClient200JSONResponse{
		Name: "Client Name",
	}, nil
}

type AdminHandler struct {
    DB *dbpool.Pool
}
func (s *AdminHandler) GetAdmins(_ context.Context, _ api.GetAdminRequestObject) (api.GetAdminResponseObject, error) {
    // use s.DB to query the database
	return api.GetAdmin200JSONResponse{
		Name: "Client Name",
	}, nil
}

type Server struct {
    ClientHandler
    AdminHandler
}

// compile-time check
var _ api.StrictServerInterface = (*Server)(nil)

func NewServer(db *dbpool.Pool) *Server {
    return &Server{
        ClientHandler: ClientHandler{},
        AdminHandler: AdminHandler{DB: db},
    }
}
```

## Get Started

- Install the Requirements
- Copy the example `.env.example` file and adjust to your use case: `cp .env.example .env`
- Prepare local development (start postgres): `make start-dev-db`
- Run migrations: `make up`
- Generate the API and DB code: `make generate`
- Start the server `go run .`
- In debug mode (`DEBUG_MODE=true`), routes are automatically printed on startup
- Test the server:

```bash
curl -X POST "http://localhost:8080/user" -H "Content-Type: application/json" -d '{"first_name": "John", "last_name": "Doe", "email": "john.doe@example.com"}'
curl "http://localhost:8080/user?user_id=<uuid>"
```
